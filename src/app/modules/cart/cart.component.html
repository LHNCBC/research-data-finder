<div class="v-box">
  <div class="spacer"></div>
  <div class="cart-header" role="heading" aria-level="1">
    <mat-icon svgIcon="shopping_cart_black"></mat-icon>&nbsp;&nbsp;<b>{{pluralFormOfRecordType}} in Cart:</b>
  </div>

  @if (listItems.length > 0) {
    @if (resourceType === 'ResearchStudy') {
      <div class="spacer"></div>
    }
    @if (resourceType === 'ResearchStudy') {
      <label class="info">
        <span class="info-icon" aria-hidden="true"></span>
      Patients will be added to the cohort if they participate in one of the studies in the cart.</label>
    }
    <div class="v-box list" [class.list--tree-view]="isTree()" [class.single-top-item]="listItems.length === 1" role="table">
      <div class="v-box list-header" role="rowgroup">
        @if (isTree()) {
          <div class="h-box switch-group">
            @if (listItems.length > 1) {
              <mat-radio-group
                [(ngModel)]="cart.logicalOperator[resourceType]"
                aria-label="Select an operator to combine criteria">
                <mat-radio-button value="and">AND</mat-radio-button>
                <mat-radio-button value="or">OR</mat-radio-button>
              </mat-radio-group>
            }
            @if (listItems.length > 1) {
              <div class="spacer"></div>
            }
            <label class="info">
              <span class="info-icon" aria-hidden="true"></span>
              AND = Patients will be added to the cohort if they meet all criteria in the cart; OR = Patients will be added if they meet any of the criteria.
            </label>
          </div>
        }
        <div class="h-box list-title" role="row">
          @if (isTree()) {
            <div class="list-toolbar" role="columnheader">
              <button type="button"
                mat-mini-fab color="basic"
                [attr.aria-label]="createRemoveGroupTooltip"
                [matTooltip]="createRemoveGroupTooltip"
                [matMenuTriggerFor]="menu"
                [disabled]="">
                <mat-icon svgIcon="more_vert"></mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="groupAllItems()">Group all records
                  with the same data types
                </button>
                <button mat-menu-item (click)="groupSelectedItems()">Group
                  selected records
                </button>
                <button mat-menu-item (click)="ungroupAllItems()">Ungroup all
                  records
                </button>
                <button mat-menu-item (click)="ungroupSelectedItems()">Ungroup
                  selected records
                </button>
              </mat-menu>
            </div>
          }
          <div class="list-toolbar list-toolbar__icon" role="columnheader"></div>
          @for (column of columnDescriptions; track column) {
            <div class="cell cell-{{resourceType}}-{{column.element}}" role="columnheader">{{column.displayName}}</div>
          }
          @if (resourceType === 'Variable' || resourceType === 'Observation') {
            <div class="cell cell-Variable-constraint" role="columnheader">Value constraint</div>
          }
        </div>
      </div>
      <div class="v-box list-body" role="rowgroup">
        <!-- the top level list -->
        @for (listItem of listItems; track listItem) {
          <div class="v-box list-item">
            <!-- individual records and group headers -->
            @if (isTree()) {
              <div class="condition-label">{{cart.logicalOperator[resourceType]}}</div>
            }
            <div class="h-box" [class.group-header]="cart.isGroup(listItem)" role="row">
              @if (isTree()) {
                <div class="list-toolbar" role="cell">
                  @if (isTree()) {
                    <mat-checkbox
                      [attr.aria-label]="cart.isGroup(listItem) ? selectGroupTooltip : selectRecordTooltip"
                      [matTooltip]="cart.isGroup(listItem) ? selectGroupTooltip : selectRecordTooltip"
                      (change)="toggleSelection(listItem, $event.checked)"
                      [checked]="selectedItems.has(listItem)">
                    </mat-checkbox>
                  }
                </div>
              }
              <div class="list-toolbar list-toolbar__icon" role="cell">
                <button
                  type="button"
                  mat-mini-fab class="mini-fab-32" color="basic"
                  (click)="removeRecordFromCart(resourceType, listItem)"
                  [attr.aria-label]="cart.isGroup(listItem) ? removeGroupTooltip : removeRecordTooltip"
                  [matTooltip]="cart.isGroup(listItem) ? removeGroupTooltip : removeRecordTooltip">
                  <mat-icon svgIcon="clear"></mat-icon>
                </button>
              </div>
              @for (column of columnDescriptions; track column) {
                <div class="cell cell-{{resourceType}}-{{column.element}}"
                  role="cell">
                  <app-ellipsis-text [text]="getCellText(listItem, column.element)"></app-ellipsis-text>
                </div>
              }
              @if (resourceTypeColumns === 'Variable') {
                @switch (!cart.getVariableType(listItem)) {
                  @case (true) {
                    <div class="cell cell-Variable-constraint h-box" role="cell">
                      <label>Loading...</label> <mat-spinner [diameter]="23"></mat-spinner>
                    </div>
                  }
                  @default {
                    @switch (cart.getVariableType(listItem)) {
                      @case ('empty') {
                        <div class="cell cell-Variable-constraint h-box" role="cell">No data found for this variable.</div>
                      }
                      @case ('error') {
                        <div class="cell cell-Variable-constraint h-box" role="cell">Error loading data for this variable.</div>
                      }
                      @default {
                        @switch (cart.isGroup(listItem)) {
                          @case (true) {
                            <app-search-parameter-value
                              role="cell"
                              class="cell cell-Variable-constraint"
                              valueLabelText="Test value"
                              unitLabelText="Test value unit"
                              [required]="false"
                              [(ngModel)]="cart.variableData[listItem[0].id].value"
                              (ngModelChange)="cart.updateVariableGroupValues(listItem)"
                              [observationCodes]="[listItem[0].id]"
                              [unitList]="cart.variableUnits[listItem[0].id]"
                              [datatype]="cart.getVariableType(listItem)">
                            </app-search-parameter-value>
                          }
                          @case (false) {
                            <app-search-parameter-value
                              role="cell"
                              class="cell cell-Variable-constraint"
                              valueLabelText="Test value"
                              unitLabelText="Test value unit"
                              [required]="false"
                              [(ngModel)]="cart.variableData[listItem.id].value"
                              [observationCodes]="[listItem.id]"
                              [unitList]="cart.variableUnits[listItem.id]"
                              [datatype]="cart.getVariableType(listItem)">
                            </app-search-parameter-value>
                          }
                        }
                      }
                    }
                  }
                }
              }
            </div>
            <!-- nested list of records in a group -->
            @if (cart.isGroup(listItem)) {
              @for (innerItem of listItem; track innerItem) {
                <div class="h-box list-item" role="row">
                  <div class="condition-label">or</div>
                  <div class="list-toolbar" role="cell">
                    <mat-checkbox
                      [attr.aria-label]="selectRecordTooltip"
                      [matTooltip]="selectRecordTooltip"
                      (change)="toggleSelection(innerItem, $event.checked)"
                      [checked]="selectedItems.has(innerItem)">
                    </mat-checkbox>
                  </div>
                  <div class="list-toolbar list-toolbar__spacer"></div>
                  <div class="list-toolbar list-toolbar__icon" role="cell">
                    <button
                      type="button"
                      mat-mini-fab class="mini-fab-32" color="basic"
                      (click)="removeRecordFromCart(resourceType, innerItem)"
                      [attr.aria-label]="removeRecordTooltip"
                      [matTooltip]="removeRecordTooltip">
                      <mat-icon svgIcon="clear"></mat-icon>
                    </button>
                  </div>
                  @for (column of columnDescriptions; track column; let index = $index) {
                    <div
                      class="cell cell-{{resourceType}}-{{column.element}} cell-index-{{index}}"  role="cell">
                      <app-ellipsis-text [text]="getCellText(innerItem, column.element)"></app-ellipsis-text>
                    </div>
                  }
                  <div class="cell cell-Variable-constraint" role="cell"></div>
                </div>
              }
            }
          </div>
        }
      </div>
    </div>
  } @else {
    <label>No {{pluralFormOfRecordType.toLowerCase()}} in the cart. Select the {{pluralFormOfRecordType.toLowerCase()}} for which you want to build a cohort of patients.</label>
  }
</div>
